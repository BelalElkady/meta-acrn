Don't hardcode install paths.

Needs more work, in that massive changes don't impact e.g. systemd units, but at
least $libdir is set right.

Upstream-Status: Pending
Signed-off-by: Ross Burton <ross.burton@intel.com>

From 0ffd0ad1f3c9daa4c72aadbf7a1a1b581579dbd0 Mon Sep 17 00:00:00 2001
From: Ross Burton <ross.burton@intel.com>
Date: Tue, 15 Jan 2019 14:49:48 +0000
Subject: [PATCH] XXX tools: don't hardcode install paths

Instead of hardcoding where binaries are installed, add variables that packagers
can override.

TODO replace hard-coded paths in files too

Signed-off-by: Ross Burton <ross.burton@intel.com>
---
diff --git a/devicemodel/Makefile b/devicemodel/Makefile
index 32c52193..682d187d 100644
--- a/devicemodel/Makefile
+++ b/devicemodel/Makefile
@@ -4,0 +5,2 @@ include ../VERSION
+include ../paths.make
+
@@ -213 +215 @@ install: $(DM_OBJDIR)/$(PROGRAM) install-samples-nuc install-samples-mrb install
-	install -D --mode=0755 $(DM_OBJDIR)/$(PROGRAM) $(DESTDIR)/usr/bin/$(PROGRAM)
+	install -D --mode=0755 $(DM_OBJDIR)/$(PROGRAM) $(DESTDIR)$(bindir)/$(PROGRAM)
@@ -216 +218 @@ install-samples-up2: $(SAMPLES_UP2)
-	install -D -t $(DESTDIR)/usr/share/acrn/samples/up2 $^
+	install -D -t $(DESTDIR)$(datadir)/acrn/samples/up2 $^
@@ -219 +221 @@ install-samples-nuc: $(SAMPLES_NUC)
-	install -D -t $(DESTDIR)/usr/share/acrn/samples/nuc $^
+	install -D -t $(DESTDIR)$(datadir)/acrn/samples/nuc $^
@@ -222,3 +224,3 @@ install-samples-mrb: $(SAMPLES_MRB)
-	install -D -t $(DESTDIR)/usr/share/acrn/samples/apl-mrb $^
-	install -d $(DESTDIR)/usr/lib/systemd/system/
-	install -p -D -m 0644 ./samples/apl-mrb/acrn_guest.service $(DESTDIR)/usr/lib/systemd/system
+	install -D -t $(DESTDIR)$(datadir)/acrn/samples/apl-mrb $^
+	install -d $(DESTDIR)$(systemd_unitdir)/system/
+	install -p -D -m 0644 ./samples/apl-mrb/acrn_guest.service $(DESTDIR)$(systemd_unitdir)/system
@@ -227,2 +229,2 @@ install-bios: $(BIOS_BIN)
-	install -d $(DESTDIR)/usr/share/acrn/bios
-	install -D --mode=0664 -t $(DESTDIR)/usr/share/acrn/bios $^
+	install -d $(DESTDIR)$(datadir)/acrn/bios
+	install -D --mode=0664 -t $(DESTDIR)$(datadir)/acrn/bios $^
diff --git a/devicemodel/vmcfg/Makefile b/devicemodel/vmcfg/Makefile
index df323d22..7d0e04af 100644
--- a/devicemodel/vmcfg/Makefile
+++ b/devicemodel/vmcfg/Makefile
@@ -3,0 +4 @@ include $(BASEDIR)/vmcfg/scripts/kconfig/kconfig.mk
+include ../../paths.make
@@ -8,2 +9,2 @@ install:
-	install -d $(DESTDIR)/usr/share/acrn/samples/apl-mrb
-	install -t $(DESTDIR)/usr/share/acrn/samples/apl-mrb $(BASEDIR)/vmcfg/apl-mrb/mrb-env-setup.sh
+	install -d $(DESTDIR)$(datadir)/acrn/samples/apl-mrb
+	install -t $(DESTDIR)$(datadir)/acrn/samples/apl-mrb $(BASEDIR)/vmcfg/apl-mrb/mrb-env-setup.sh
diff --git a/hypervisor/Makefile b/hypervisor/Makefile
index bba4587d..7f851c28 100644
--- a/hypervisor/Makefile
+++ b/hypervisor/Makefile
@@ -41,0 +42,2 @@ include scripts/kconfig/kconfig.mk
+include ../paths.make
+
@@ -308 +310 @@ ifeq ($(BOARD),up2)
-	install -D $(HV_OBJDIR)/$(HV_FILE).32.out $(DESTDIR)/usr/lib/acrn/$(HV_FILE).up2.sbl
+	install -D $(HV_OBJDIR)/$(HV_FILE).32.out $(DESTDIR)$(libdir)/acrn/$(HV_FILE).up2.sbl
@@ -310 +312 @@ else
-	install -D $(HV_OBJDIR)/$(HV_FILE).32.out $(DESTDIR)/usr/lib/acrn/$(HV_FILE).sbl
+	install -D $(HV_OBJDIR)/$(HV_FILE).32.out $(DESTDIR)$(libdir)/acrn/$(HV_FILE).sbl
@@ -315,2 +317,2 @@ ifeq ($(BOARD),up2)
-	install -D $(HV_OBJDIR)/$(HV_FILE).out $(DESTDIR)/usr/lib/acrn/$(HV_FILE).up2.sbl.out
-	install -D $(HV_OBJDIR)/$(HV_FILE).map $(DESTDIR)/usr/lib/acrn/$(HV_FILE).up2.sbl.map
+	install -D $(HV_OBJDIR)/$(HV_FILE).out $(DESTDIR)$(libdir)/acrn/$(HV_FILE).up2.sbl.out
+	install -D $(HV_OBJDIR)/$(HV_FILE).map $(DESTDIR)$(libdir)/acrn/$(HV_FILE).up2.sbl.map
@@ -318,2 +320,2 @@ else
-	install -D $(HV_OBJDIR)/$(HV_FILE).out $(DESTDIR)/usr/lib/acrn/$(HV_FILE).sbl.out
-	install -D $(HV_OBJDIR)/$(HV_FILE).map $(DESTDIR)/usr/lib/acrn/$(HV_FILE).sbl.map
+	install -D $(HV_OBJDIR)/$(HV_FILE).out $(DESTDIR)$(libdir)/acrn/$(HV_FILE).sbl.out
+	install -D $(HV_OBJDIR)/$(HV_FILE).map $(DESTDIR)$(libdir)/acrn/$(HV_FILE).sbl.map
diff --git a/paths.make b/paths.make
new file mode 100644
index 00000000..65a23582
--- /dev/null
+++ b/paths.make
@@ -0,0 +1,8 @@
+DESTDIR ?=
+prefix ?= /usr
+bindir ?= $(prefix)/bin
+libdir ?= $(prefix)/lib64
+nonarchlibdir ?= $(prefix)/lib
+datadir ?= $(prefix)/share
+includedir ?= $(prefix)/include
+systemd_unitdir ?= $(prefix)/lib/systemd
diff --git a/tools/acrn-crashlog/Makefile b/tools/acrn-crashlog/Makefile
index 3f74c99d..6d39df3f 100644
--- a/tools/acrn-crashlog/Makefile
+++ b/tools/acrn-crashlog/Makefile
@@ -4,0 +5,2 @@
+include ../../paths.make
+
@@ -100,17 +102,17 @@ install:
-	@install -d $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 $(BUILDDIR)/acrnprobe/bin/acrnprobe $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/debugger $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/usercrash_c $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/usercrash_s $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 data/crashlogctl $(DESTDIR)/usr/bin/
-	@install -p -D -m 0755 data/usercrash-wrapper $(DESTDIR)/usr/bin/
-	@install -d $(DESTDIR)/usr/share/acrn/crashlog
-	@install -p -D -m 0644 data/40-watchdog.conf $(DESTDIR)/usr/share/acrn/crashlog
-	@install -p -D -m 0644 data/80-coredump.conf $(DESTDIR)/usr/share/acrn/crashlog
-	@install -d $(DESTDIR)/usr/share/defaults/telemetrics/
-	@install -p -D -m 0644 data/acrnprobe.xml $(DESTDIR)/usr/share/defaults/telemetrics/
-	@install -d $(DESTDIR)/usr/lib/systemd/system/
-	@install -p -D -m 0644 data/acrnprobe.service $(DESTDIR)/usr/lib/systemd/system/
-	@install -p -D -m 0644 data/usercrash.service $(DESTDIR)/usr/lib/systemd/system/
-	@install -d $(DESTDIR)/usr/lib/tmpfiles.d
-	@install -p -D -m 0644 data/acrn-crashlog-dirs.conf $(DESTDIR)/usr/lib/tmpfiles.d/
+	@install -d $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 $(BUILDDIR)/acrnprobe/bin/acrnprobe $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/debugger $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/usercrash_c $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 $(BUILDDIR)/usercrash/bin/usercrash_s $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 data/crashlogctl $(DESTDIR)$(bindir)/
+	@install -p -D -m 0755 data/usercrash-wrapper $(DESTDIR)$(bindir)/
+	@install -d $(DESTDIR)$(datadir)/acrn/crashlog
+	@install -p -D -m 0644 data/40-watchdog.conf $(DESTDIR)$(datadir)/acrn/crashlog
+	@install -p -D -m 0644 data/80-coredump.conf $(DESTDIR)$(datadir)/acrn/crashlog
+	@install -d $(DESTDIR)$(datadir)/defaults/telemetrics/
+	@install -p -D -m 0644 data/acrnprobe.xml $(DESTDIR)$(datadir)/defaults/telemetrics/
+	@install -d $(DESTDIR)$(systemd_unitdir)/system/
+	@install -p -D -m 0644 data/acrnprobe.service $(DESTDIR)$(systemd_unitdir)/system/
+	@install -p -D -m 0644 data/usercrash.service $(DESTDIR)$(systemd_unitdir)/system/
+	@install -d $(DESTDIR)$(libdir)/tmpfiles.d
+	@install -p -D -m 0644 data/acrn-crashlog-dirs.conf $(DESTDIR)$(libdir)/tmpfiles.d/
@@ -120,2 +122,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/acrnprobe" ];then \
-		$(RM) $(DESTDIR)/usr/bin/acrnprobe; \
+	@if [ -e "$(DESTDIR)$(bindir)/acrnprobe" ];then \
+		$(RM) $(DESTDIR)$(bindir)/acrnprobe; \
@@ -123,3 +125,3 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/crashlogctl" ];then \
-		$(DESTDIR)/usr/bin/crashlogctl disable && \
-		$(RM) $(DESTDIR)/usr/bin/crashlogctl; \
+	@if [ -e "$(DESTDIR)$(bindir)/crashlogctl" ];then \
+		$(DESTDIR)$(bindir)/crashlogctl disable && \
+		$(RM) $(DESTDIR)$(bindir)/crashlogctl; \
@@ -127,2 +129,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/debugger" ];then \
-		$(RM) $(DESTDIR)/usr/bin/debugger; \
+	@if [ -e "$(DESTDIR)$(bindir)/debugger" ];then \
+		$(RM) $(DESTDIR)$(bindir)/debugger; \
@@ -130,2 +132,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/usercrash_c" ];then \
-		$(RM) $(DESTDIR)/usr/bin/usercrash_c; \
+	@if [ -e "$(DESTDIR)$(bindir)/usercrash_c" ];then \
+		$(RM) $(DESTDIR)$(bindir)/usercrash_c; \
@@ -133,2 +135,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/usercrash_s" ];then \
-		$(RM) $(DESTDIR)/usr/bin/usercrash_s; \
+	@if [ -e "$(DESTDIR)$(bindir)/usercrash_s" ];then \
+		$(RM) $(DESTDIR)$(bindir)/usercrash_s; \
@@ -136,2 +138,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/bin/usercrash-wrapper" ];then \
-		$(RM) $(DESTDIR)/usr/bin/usercrash-wrapper; \
+	@if [ -e "$(DESTDIR)$(bindir)/usercrash-wrapper" ];then \
+		$(RM) $(DESTDIR)$(bindir)/usercrash-wrapper; \
@@ -139,2 +141,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/share/acrn/crashlog/40-watchdog.conf" ];then \
-		$(RM) $(DESTDIR)/usr/share/acrn/crashlog/40-watchdog.conf; \
+	@if [ -e "$(DESTDIR)$(datadir)/acrn/crashlog/40-watchdog.conf" ];then \
+		$(RM) $(DESTDIR)$(datadir)/acrn/crashlog/40-watchdog.conf; \
@@ -142,2 +144,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/share/acrn/crashlog/80-coredump.conf" ];then \
-		$(RM) $(DESTDIR)/usr/share/acrn/crashlog/80-coredump.conf; \
+	@if [ -e "$(DESTDIR)$(datadir)/acrn/crashlog/80-coredump.conf" ];then \
+		$(RM) $(DESTDIR)$(datadir)/acrn/crashlog/80-coredump.conf; \
@@ -145,2 +147,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/share/defaults/telemetrics/acrnprobe.xml" ];then \
-		$(RM) $(DESTDIR)/usr/share/defaults/telemetrics/acrnprobe.xml; \
+	@if [ -e "$(DESTDIR)$(datadir)/defaults/telemetrics/acrnprobe.xml" ];then \
+		$(RM) $(DESTDIR)$(datadir)/defaults/telemetrics/acrnprobe.xml; \
@@ -148,2 +150,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/lib/systemd/system/acrnprobe.service" ];then \
-		$(RM) $(DESTDIR)/usr/lib/systemd/system/acrnprobe.service; \
+	@if [ -e "$(DESTDIR)$(systemd_unitdir)/system/acrnprobe.service" ];then \
+		$(RM) $(DESTDIR)$(systemd_unitdir)/system/acrnprobe.service; \
@@ -151,2 +153,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/lib/systemd/system/usercrash.service" ];then \
-		$(RM) $(DESTDIR)/usr/lib/systemd/system/usercrash.service; \
+	@if [ -e "$(DESTDIR)$(systemd_unitdir)/system/usercrash.service" ];then \
+		$(RM) $(DESTDIR)$(systemd_unitdir)/system/usercrash.service; \
@@ -154,2 +156,2 @@ uninstall:
-	@if [ -e "$(DESTDIR)/usr/lib/tmpfiles.d/acrn-crashlog-dirs.conf" ];then \
-		$(RM) $(DESTDIR)/usr/lib/tmpfiles.d/acrn-crashlog-dirs.conf; \
+	@if [ -e "$(DESTDIR)$(libdir)/tmpfiles.d/acrn-crashlog-dirs.conf" ];then \
+		$(RM) $(DESTDIR)$(libdir)/tmpfiles.d/acrn-crashlog-dirs.conf; \
diff --git a/tools/acrn-manager/Makefile b/tools/acrn-manager/Makefile
index 781c7dee..d263ea0f 100644
--- a/tools/acrn-manager/Makefile
+++ b/tools/acrn-manager/Makefile
@@ -0,0 +1,2 @@
+include ../../paths.make
+
@@ -87,9 +89,9 @@ install: $(OUT_DIR)/acrnctl $(OUT_DIR)/acrn_mngr.h $(OUT_DIR)/libacrn-mngr.a
-	install -d $(DESTDIR)/usr/bin
-	install -d $(DESTDIR)/usr/lib/systemd/system
-	install -d $(DESTDIR)/usr/lib64/
-	install -d $(DESTDIR)/usr/include/acrn
-	install -t $(DESTDIR)/usr/bin $(OUT_DIR)/acrnctl
-	install -t $(DESTDIR)/usr/bin $(OUT_DIR)/acrnd
-	install -t $(DESTDIR)/usr/lib64/ $(OUT_DIR)/libacrn-mngr.a
-	install -t $(DESTDIR)/usr/include/acrn $(OUT_DIR)/acrn_mngr.h
-	install -p -D -m 0644 $(OUT_DIR)/acrnd.service $(DESTDIR)/usr/lib/systemd/system
+	install -d $(DESTDIR)$(bindir)
+	install -d $(DESTDIR)$(systemd_unitdir)/system
+	install -d $(DESTDIR)$(libdir)
+	install -d $(DESTDIR)$(includedir)/acrn
+	install -t $(DESTDIR)$(bindir) $(OUT_DIR)/acrnctl
+	install -t $(DESTDIR)$(bindir) $(OUT_DIR)/acrnd
+	install -t $(DESTDIR)$(libdir) $(OUT_DIR)/libacrn-mngr.a
+	install -t $(DESTDIR)$(includedir)/acrn $(OUT_DIR)/acrn_mngr.h
+	install -p -D -m 0644 $(OUT_DIR)/acrnd.service $(DESTDIR)$(systemd_unitdir)/system
diff --git a/tools/acrnbridge/Makefile b/tools/acrnbridge/Makefile
index fe3367d4..d403c3b9 100644
--- a/tools/acrnbridge/Makefile
+++ b/tools/acrnbridge/Makefile
@@ -0,0 +1 @@
+include ../../paths.make
@@ -3 +3,0 @@ OUT_DIR ?= .
-SYSTEMD_NETWORKDIR := usr/lib
@@ -12,5 +12,5 @@ install:
-	install -d $(DESTDIR)/$(SYSTEMD_NETWORKDIR)/systemd/network
-	install -p -D -m 0644 $(OUT_DIR)/acrn.netdev $(DESTDIR)/$(SYSTEMD_NETWORKDIR)/systemd/network/50-acrn.netdev
-	install -p -D -m 0644 $(OUT_DIR)/acrn.network $(DESTDIR)/$(SYSTEMD_NETWORKDIR)/systemd/network/50-acrn.network
-	install -p -D -m 0644 $(OUT_DIR)/acrn_tap0.netdev $(DESTDIR)/$(SYSTEMD_NETWORKDIR)/systemd/network/50-acrn_tap0.netdev
-	install -p -D -m 0644 $(OUT_DIR)/eth.network $(DESTDIR)/$(SYSTEMD_NETWORKDIR)/systemd/network/50-eth.network
+	install -d $(DESTDIR)$(systemd_unitdir)/network
+	install -p -D -m 0644 $(OUT_DIR)/acrn.netdev $(DESTDIR)$(systemd_unitdir)/network/50-acrn.netdev
+	install -p -D -m 0644 $(OUT_DIR)/acrn.network $(DESTDIR)$(systemd_unitdir)/network/50-acrn.network
+	install -p -D -m 0644 $(OUT_DIR)/acrn_tap0.netdev $(DESTDIR)$(systemd_unitdir)/network/50-acrn_tap0.netdev
+	install -p -D -m 0644 $(OUT_DIR)/eth.network $(DESTDIR)$(systemd_unitdir)/network/50-eth.network
diff --git a/tools/acrnlog/Makefile b/tools/acrnlog/Makefile
index 8c7a9ff1..6a66d7c5 100644
--- a/tools/acrnlog/Makefile
+++ b/tools/acrnlog/Makefile
@@ -0,0 +1,2 @@
+include ../../paths.make
+
@@ -51,4 +53,4 @@ install: $(OUT_DIR)/acrnlog
-	install -d $(DESTDIR)/usr/bin
-	install -t $(DESTDIR)/usr/bin $(OUT_DIR)/acrnlog
-	install -d $(DESTDIR)/usr/lib/systemd/system
-	install -p -D -m 0644 $(OUT_DIR)/acrnlog.service $(DESTDIR)/usr/lib/systemd/system
+	install -d $(DESTDIR)$(bindir)
+	install -t $(DESTDIR)$(bindir) $(OUT_DIR)/acrnlog
+	install -d $(DESTDIR)$(systemd_unitdir)/system
+	install -p -D -m 0644 $(OUT_DIR)/acrnlog.service $(DESTDIR)$(systemd_unitdir)/system
diff --git a/tools/acrntrace/Makefile b/tools/acrntrace/Makefile
index fa42880a..f71f6865 100644
--- a/tools/acrntrace/Makefile
+++ b/tools/acrntrace/Makefile
@@ -0,0 +1,2 @@
+include ../../paths.make
+
@@ -49,2 +51,2 @@ install: $(OUT_DIR)/acrntrace
-	install -d $(DESTDIR)/usr/bin
-	install -t $(DESTDIR)/usr/bin $(OUT_DIR)/acrntrace
+	install -d $(DESTDIR)$(bindir)
+	install -t $(DESTDIR)$(bindir) $(OUT_DIR)/acrntrace
